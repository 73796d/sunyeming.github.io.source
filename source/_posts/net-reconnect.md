---
title: 移动平台游戏网络重连方案的总结
date: 2017-11-23 18:22:52
categories: net
tags: [iOS, Android, net] 
---


在移动平台下，网络信号频繁变动，造成更高的丢包率，更大的延迟抖动，不稳定的网络连接。如果处理不好，会造成很不好的体验。
 
## 特点：

1. 网络制式多：2G/3G/4G/wifi
1. 各种制式之间的网络速度差异大
1. 地理位置变化中网络的切换（信号制式之间的转换、基站之间的转换）等 
1. 信号强度（建筑死角、隧道、深山老林、 无线信号会衰弱）
1. 信号不稳定（在高速移动的火车上，会有明显的多普勒效应，网络延迟抖动）
1. 网络拥塞（人口密集的场所，运营商降低人均通讯带宽，网络延迟增大）
 
 
 
 
## 影响：

1. 网络慢导致请求响应时间变长甚至断线
1. 网络不稳定导致上行包/下行包丢失
1. 弱网络加剧异步设计系统的响应延迟


## 解决方案：

### 1.如何解决网络切换导致的网络中断
当在网络制式之间切换时，能够感知到网络的切换，ios下可以采用官方的例子reachability进行感知，Android上提供了Connectivity Manager服务可以实现同样的功能。


### 2.如何解决网络慢导致的响应延迟
* 客户端保证一发一/多收模式

大部分协议都有一个定时器，在超时时间内，客户端期待网络端回包。根据协议的不同，服务端回包的个数也不同，例如对玩家购买金币的操作，服务端在回多个包，包括扣钻石的回包，反馈操作是否成功的回包等。不管是一发一收还是一发多收的模式，一般情况下，每一个上行包都有一个对应的反馈下行包老表示操作结束，在这个反馈下行包之前，服务端也可能会发送别的回包给客户端。

然而有些协议不需要期待下行包，所以客户端也会启动一个协议白名单机制。在白名单中的协议，客户端发包之后不期待回包就可以继续操作。常见的GM相关的协议，平台请求的协议都不需要期待回包。

在超时时间内，客户端对UI交互进行锁定（模态菊花）。

如果在超时时间之后客户端没有收到回包，此时客户端会启动超时探测。

* 客户端超时探测

对于在超时时间内没有期待到回包的情况，客户端主动向服务器发送一个探测包。这个探测包只包含一个包头，不携带任何信息。在发送探测包的同时，客户端同样为这个探测包启动一个定时器，如果在超时时间内探测包有回包，我们认定上行包丢失（也有下行包丢失的情况），直接忽略这种情况；如果探测包在超时时间内也没有回包，那么这时候我们断定网络出了问题，直接弹出提示框告知玩家请求失败，由玩家手动点击重连进入断线重连程序。

*  断线重连

	1. 简化登录流程
		
		弱网环境下，玩家出现掉线的情况比较频繁，所以登录流程需要细分，区分完整登录和断线重连的情况。
		
	2. 延迟下线机制
		
		当玩家出现掉线后，服务器不马上清除玩家角色数据，而是为玩家角色数据设置一个延迟下线时间（如5分钟），然后在主程序中的时间事件里检查角色数据状态，如果玩家在时间未过期之前重新连接上，就可以直接将角色数据下发客户端，否则清除数据，下册玩家重新登录上走完整登录流程。
		
	3. 尝试重连
	       
	       当检测到断线后，可以尝试重连几次
	       
	4. 显示连接
		
		在尝试连接几次之后，任然无法连接。可以给用户弹出提示框，中断游戏流程，引导用户重新连接。
	
		
	
### 3.如何解决丢包问题

弱网环境下导致丢包具体来说有两种情况，一是上行包丢失，即服务器没有收到请求协议，客户端只需要重新请求即可；二是下行包丢失，服务器已经收到请求协议并处理，由于网络问题，客户端未收到回包，客户端不知道服务器是否已处理以及处理返回的数据是什么。
下行包丢失又可以细分两种情况，一是对于客户端收不到回包不会应县玩家收益的请求，则不需要做特别的处理，这类请求回包丢失时，玩家一般可以重新登录或刷新界面可以恢复数据的请求，典型的有领取任务奖励；二是对于客户端收不到回包会影响玩家的请求，列入战斗过程中加血，如果是网络问题，走断线重连流程，如果是下行包丢失，则需要形影的机制俩处理。主要手段是消息会话机制。

消息回话机制的实现思路是客户端和服务端配合工作，首先客户端为每个协议请求分配一个唯一的会话id，当客户端重复操作的时候，如果上一个请求没有收到服务端的响应，志哥时候就会分配相同的会话id。服务端收到相同的会话id，则认为是重复的请求，重复的请求本质上是上一次请求的历史回放。应对回放的请求，最直接的解决方案就是返回回放的回复数据。因此只需要在逻辑处理完“非重复请求”后以及将回复数据提交网络层返回客户端之前，对回放数据进行缓存，在后续遇到这次回复的重复请求时，绕过逻辑处理，直接将之前缓存的回复数据返回客户端即可。



## 心跳包
心跳包是现在常见的保活手段，也可以让服务器知道是否与客户端断开连接（物理上的），从而进一步知道是否要清除玩家数据，减轻服务器压力。